#!/bin/bash

needs_tool cmake
needs_tool nasm

fetch_source http://ftp.videolan.org/pub/videolan/x265/x265_4.1.tar.gz 11880a3aa9e4ee618f539a2d6a8ece0ea442f505

do_unpack

# fix for cmake 4+
sed -i.bak \
    -e '1s/^/cmake_minimum_required (VERSION 3.10)\n/' \
    -e '/cmake_minimum_required/{ 1!d; }' \
    -e '/cmake_policy(SET CMP0025 OLD)/,/endif()/d' \
    -e '/cmake_policy(SET CMP0042 NEW)/,/endif()/d' \
    -e '/cmake_policy(SET CMP0054 OLD)/,/endif()/d' \
    -e 's/if(POLICY CMP0025)//' \
    -e 's/if(POLICY CMP0042)//' \
    -e 's/if(POLICY CMP0054)//' \
    -e 's/if(${CMAKE_CXX_COMPILER_ID} STREQUAL "Clang")/if(CMAKE_CXX_COMPILER_ID MATCHES "Clang")/' \
    "$SRCDIR"/source/CMakeLists.txt
sed -i.bak \
    -e 's/cmake_minimum_required (VERSION 2.8.11)/cmake_minimum_required (VERSION 3.10)/' \
    "$SRCDIR"/source/dynamicHDR10/CMakeLists.txt

SRCDIR="$SRCDIR/source"
pushd_src
BUILDDIR="$SRCDIR/../build/norm/12bit"
mkdir -p "$BUILDDIR"
cd "$BUILDDIR"
do_auto_configure -DHIGH_BIT_DEPTH=ON -DEXPORT_C_API=OFF -DENABLE_SHARED=OFF -DENABLE_CLI=OFF -DMAIN12=ON -DENABLE_LIBNUMA=OFF
do_make

BUILDDIR="$SRCDIR/../build/norm/10bit"
mkdir -p "$BUILDDIR"
cd "$BUILDDIR"
do_auto_configure -DHIGH_BIT_DEPTH=ON -DEXPORT_C_API=OFF -DENABLE_SHARED=OFF -DENABLE_CLI=OFF -DENABLE_LIBNUMA=OFF
do_make

BUILDDIR="$SRCDIR/../build/norm/8bit"
mkdir -p "$BUILDDIR"
cd "$BUILDDIR"
ln -sf ../10bit/libx265.a libx265_main10.a
ln -sf ../12bit/libx265.a libx265_main12.a
do_auto_configure -DEXTRA_LIB="x265_main10.a;x265_main12.a" -DEXTRA_LINK_FLAGS=-L. -DLINKED_10BIT=ON -DLINKED_12BIT=ON -DENABLE_LIBNUMA=OFF
do_make
mv libx265.a libx265_main8.a
if [[ $OSTYPE == *linux* ]]; then
    printf "create libx265.a\naddlib libx265_main8.a\naddlib libx265_main10.a\naddlib libx265_main12.a\nsave\nend\n" | ar -M
elif [[ $OSTYPE == *darwin* ]]; then
    /usr/bin/libtool -static -o libx265.a libx265_main8.a libx265_main10.a libx265_main12.a
else
    for i in libx265_main*.a; do
	mkdir -p "${i%.*}"
	cd "${i%.*}"
	ar -x ../"$i"
	cd ..
    done
    ar crD libx265.a libx265_main*/*.o
fi
do_install
popd_src
