#!/bin/bash

depends_on pkg-config
depends_on flac    ## links with libFLAC
depends_on lame    ## links with libmp3lame
depends_on file    ## links with libmagic, unclear what for
depends_on libogg
depends_on libvorbis
depends_on libpng  ## unclear what for
depends_on libopusfile

fetch_source https://prdownloads.sourceforge.net/sox/sox/14.4.2/sox-14.4.2.tar.gz f69f38f8a7ad6a88ecab3862d74db4edcd796695

CONFFLAGS=(
--without-libltdl ## opportunistic linking
--without-amrwb   ## opportunistic linking
--without-amrnb   ## opportunistic linking
--without-mad     ## opportunistic linking
--without-sndfile ## opportunistic linking
)

## sox does not like -ffast-math
do_unpack

fetch_file https://raw.githubusercontent.com/Homebrew/formula-patches/master/libtool/configure-pre-0.4.2.418-big_sur.diff 99cc25af3c3f498b2ca6b077fc6a5f595ff6ffe1
do_patch "$FILENAME" -p1

do_patch_inline -p1 <<EOF
diff --git a/src/coreaudio.c b/src/coreaudio.c
index f6f20c13..27623922 100644
--- a/src/coreaudio.c
+++ b/src/coreaudio.c
@@ -152,6 +152,8 @@ static int setup(sox_format_t *ft, int is_input)
               for (i = 0; i < device_count; i++)
               {
                   char name[256];
+
+                  property_size = sizeof(name);
                   status = AudioDeviceGetProperty(devices[i],0,false,kAudioDevicePropertyDeviceName,&property_size,&name);
 
                   lsx_report("Found Audio Device \"%s\"\n",name);
EOF

CFLAGS="${CFLAGS/-Ofast/} -Wno-incompatible-function-pointer-types" \
CXXFLAGS="${CXXFLAGS/-Ofast/} -Wno-incompatible-function-pointer-types" \
do_compile "${CONFFLAGS[@]}"
