#!/bin/bash

depends_on pkg-config ## to find libraries
depends_on bzip2      ## _bz2 module
depends_on libffi     ## _ctypes module
depends_on libgdbm    ## _gdbm module
depends_on libncurses ## curses module
depends_on openssl    ## ssl module
depends_on sqlite3    ## sqlite3 module
depends_on xz         ## lzma module
depends_on zlib       ## zlib module

fetch_source https://www.python.org/ftp/python/3.10.4/Python-3.10.4.tar.xz 8f684863b92bf43936b16dbb867e392f10e8ffc7

CONFFLAGS=(
--enable-shared         ## otherwise python extensions fail to load
--with-dbmliborder=gdbm ## prefer our gdbm to other dbm
)

## build breaks with parallel or Ofast, and it can't find ncursesw on linux
NOPARALLEL=1 \
CFLAGS="${CFLAGS/-Ofast/}" \
CXXFLAGS="${CXXFLAGS/-Ofast/}" \
CPPFLAGS="$CPPFLAGS -I$PREFIX/include/ncursesw" \
do_unpack_compile "${CONFFLAGS[@]}"

## small sanity check
for i in _ctypes _decimal _gdbm bz2 curses lzma pyexpat sqlite3 zlib ssl; do
	"$PREFIX/bin/python3" -c "import $i"
done
"$PREFIX/bin/python3" -m venv "$SRCDIR/temp/venvtest"

## default python is now python3 everywhere
ln -sf "$PREFIX/bin/python3" "$PREFIX/bin/python"
