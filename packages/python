#!/bin/bash

depends_on pkg-config

depends_on zlib
depends_on libreadline
depends_on openssl
depends_on bzip2
depends_on libdb
depends_on libncurses
depends_on libexpat
depends_on libgdbm
depends_on sqlite3
depends_on libffi

fetch_source https://www.python.org/ftp/python/2.7.10/Python-2.7.10.tar.xz ee5a50c5562e7448f037d35fdedc18d95c748b9e

do_unpack
do_patch_inline << 'EOF'
--- Python-2.7.10-orig/Lib/test/test_pwd.py	2015-05-23 19:09:12.000000000 +0300
+++ Python-2.7.10.tar.xz-hmd/Lib/test/test_pwd.py	2015-09-11 17:37:35.219553136 +0300
@@ -13,6 +13,7 @@
             self.assertEqual(len(e), 7)
             self.assertEqual(e[0], e.pw_name)
             self.assertIsInstance(e.pw_name, basestring)
+            if e.pw_name == '+': continue # + is a special NIS compatibility entry, has nothing else, ignore it
             self.assertEqual(e[1], e.pw_passwd)
             self.assertIsInstance(e.pw_passwd, basestring)
             self.assertEqual(e[2], e.pw_uid)
EOF
pushd_src
do_configure --enable-ipv6 --enable-unicode=ucs4 --with-system-expat --with-system-ffi \
                  --with-dbmliborder=bdb:gdbm --with-fpectl --enable-shared --with-threads
do_make
! is_without tests && env - PATH="$PATH" make test EXTRATESTOPTS='--exclude test_mhlib'
do_install
popd
