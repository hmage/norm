#!/bin/bash

fetch_source http://distfiles.dereferenced.org/pkgconf/pkgconf-2.5.1.tar.xz 402f512417561fbfb2421d0d9c05c25984a8d8c1

do_unpack

## to make running programs linked with norm-provided libraries easier, automatically add rpath to any library path
## this is useful as well for go, which doesn't use libtool, so never adds rpath as well.
do_patch_inline -p0 << 'EOF'
--- libpkgconf/fragment.c
+++ libpkgconf/fragment.c
@@ -537,6 +537,12 @@ pkgconf_fragment_len(const pkgconf_fragment_t *frag)

 		char *quoted = fragment_quote(frag);
 		len += strlen(quoted);
+		// Add rpath to all -L fragments
+		if (frag->type && frag->type == 'L') {
+			len += strlen("-Wl,-rpath,");
+			len += strlen(quoted);
+			len += 1;
+		}
 		free(quoted);

 		PKGCONF_FOREACH_LIST_ENTRY(frag->children.head, iter)
@@ -586,6 +592,14 @@ fragment_render_item(const pkgconf_fragment_t *frag, char *bptr, size_t bufremain
 		*bptr++ = frag->type;
 	}

+	// Add rpath to all -L fragments
+	if (frag->type && frag->type == 'L' && quoted != NULL) {
+		bptr += pkgconf_strlcpy(bptr, quoted, bufremain - (bptr - base));
+		*bptr++ = ' ';
+		bptr += pkgconf_strlcpy(bptr, "-Wl,-rpath,", bufremain - (bptr - base));
+	}
+
+
 	if (quoted != NULL)
 	{
 		bptr += pkgconf_strlcpy(bptr, quoted, bufremain - (bptr - base));
EOF
do_compile --with-system-includedir=/usr/include --with-system-libdir=/usr/lib
ln -fs pkgconf "$PREFIX"/bin/pkg-config
