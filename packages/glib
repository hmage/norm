#!/bin/bash

needs_tool autoconf
depends_on automake ## system-provided automake might not have libtool definitions
depends_on pkg-config
depends_on libtool
depends_on gettext
depends_on libpcre ## system-provided pcre might not support unicode (that's the case on osx), so always bring our own
## these formulas are not needed on osx -- they are guaranteed to be present in the system
if [[ $OSTYPE != *darwin* ]]; then
	depends_on libffi
	depends_on zlib
fi
[[ $OSTYPE == *linux* ]] && depends_on libmount ## glib needs it only on linux, and libmount compiles only on linux
needs_tool python3 # bin/gdbus-codegen is in python, needed by libgtk3

## 2.58 is last version that doesn't require python3
fetch_source https://ftp.gnome.org/pub/gnome/sources/glib/2.58/glib-2.58.2.tar.xz 9831bbdca749a42526d0afc4b31799e8be22037c

do_unpack
pushd_src
NOCONFIGURE=1 ./autogen.sh
popd_src

CONFFLAGS=(
--disable-libelf ## opportunistic linking with libelf for gresource tool, still works without it
--disable-selinux ## opportunistic linking with libselinux, we don't expect to manipulate or switch selinux policies anyway
--disable-fam ## opportunistic linking with libfam
--enable-static ## some programs want static version of glib
)

## these flags are needed to tell where the system libffi is located on darwin
if [[ $OSTYPE == *darwin* ]]; then
	SDKPATH=$(xcrun --show-sdk-path)
	CONFFLAGS+=(LIBFFI_CFLAGS="-I$SDKPATH/usr/include/ffi" LIBFFI_LIBS="-L$SDKPATH/usr/lib -lffi")
fi

do_compile "${CONFFLAGS[@]}"
