#!/bin/bash

depends_on zlib
depends_on brotli
depends_on libnghttp2
depends_on libuv
depends_on openssl

fetch_source https://nodejs.org/dist/v24.2.0/node-v24.2.0.tar.xz 7c25af7bff74c401956ceb4003d8880e459568b9

do_unpack
## this fixes build failure on OSX if gnu libtool is installed
sed -i.bak 's|%(python)s gyp-mac-tool filter-libtool libtool|/usr/bin/libtool|g' "$SRCDIR"/tools/gyp/pylib/gyp/generator/make.py

CONFFLAGS=(
--shared-brotli
--shared-libuv
--shared-nghttp2
--shared-zlib
--shared-openssl
)

# Norm defaults add dead-strip flags that drop unused N-API exports; remove
# them so native addons (sharp, @node-rs/argon2, etc.) can load.
LDFLAGS="${LDFLAGS//-Wl,-dead_strip_dylibs/}"
LDFLAGS="${LDFLAGS//-Wl,-dead_strip/}"
LDFLAGS="${LDFLAGS//-Wl,-x/}"

## this also fixes build failure
CFLAGS="${CFLAGS/-Ofast/} -g1" \
CXXFLAGS="${CXXFLAGS/-Ofast/} -g1" \
do_compile "${CONFFLAGS}"
