#!/bin/bash

## don't use https to download openssl source because openssl might be too old to even establish a connection!
fetch_source http://security.debian.org/debian-security/pool/updates/main/o/openssl/openssl_3.5.4.orig.tar.gz b75daac8e10f189abe28a076ba5905d363e4801f
fetch_debian http://security.debian.org/debian-security/pool/updates/main/o/openssl/openssl_3.5.4-1~deb13u2.debian.tar.xz 2a1f2a04b97dcdfa1622496197eb85c0207936f2

SSLCONFIG=(
shared ## otherwise curl will fail to link on x64, since it builds with fPIC but openssl isn't
--openssldir="$PREFIX/etc/ssl"
--libdir=lib
)
[[ $HOSTTYPE == x86_64 ]] && export KERNEL_BITS=64

do_undebian
pushd_src
./config --prefix="$PREFIX" $LDFLAGS "${SSLCONFIG[@]}"
NOPARALLEL=1 do_make all # parallel build can truncate libcrypto.so
do_test
do_install MANDIR="$PREFIX/share/man"
popd_src

## install root certificates so curl and others can use HTTPS
mkdir -p "$PREFIX"/etc/ssl/certs
install -m 644 "$NORMDIR/files/ca-bundle.crt" "$PREFIX/etc/ssl/cert.pem"
