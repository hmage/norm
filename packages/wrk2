#!/bin/bash

depends_on zlib # for zlib.h
depends_on openssl

fetch_source https://github.com/giltene/wrk2/archive/44a94c17d8e6a0bac8559b53da76848e430cb7a7.tar.gz 5c8a56f53a4a76919d98e90f670339876675ddcd

## wrk2 fails to build with luajit bundled in the repo, bring new one
fetch_file http://luajit.org/download/LuaJIT-2.0.5.tar.gz 10427215da7d424fd9e48adbea087966053cdb6f

pushd_src
tar xf "$CACHEDIR/$FILENAME" -C "deps/luajit" --strip-components 1
do_make WITH_OPENSSL="$PREFIX" CFLAGS="-std=gnu99 -O2 -g $CPPFLAGS -I./deps/luajit/src"
install -m755 wrk "$PREFIX/bin/wrk2"
popd_src
