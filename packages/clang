#!/bin/bash

requires_gcc 4.7

depends_on python ## needs python 2.7 to compile
depends_on groff  ## for installing manpages
depends_on libxml ## c-index-test has dynamic dependency on it

ENABLE_SANITIZER=yes
if ! test_cc_value "linux/perf_event.h" "PERF_TYPE_HARDWARE"; then
    ENABLE_SANITIZER=no
    add_caveat "Your headers are missing <linux/perf_event.h>, sanitizer support was disabled."
fi

if ! test_cc_value "linux/mroute6.h" "MRT6_BASE"; then
    ENABLE_SANITIZER=no
    add_caveat "Your headers are missing <linux/mroute6.h>, sanitizer support was disabled."
fi

fetch_source http://llvm.org/releases/3.7.0/llvm-3.7.0.src.tar.xz 0355c2fe01a8d17c3315069e6f2ef80c281e7dad
do_unpack

fetch_source http://llvm.org/releases/3.7.0/cfe-3.7.0.src.tar.xz 4ff8100565528b13d99a73f807e9b426c3b3bed9
intree_unpack tools/clang

if [[ $ENABLE_SANITIZER == yes ]]; then
    fetch_source http://llvm.org/releases/3.7.0/compiler-rt-3.7.0.src.tar.xz b61362b409bb7909a6d11097b5f69fded061073c
    intree_unpack projects/compiler-rt
fi

TARNAME=clang-3.7.0

BUILDDIR="$SRCDIR"-build
rm -rf "$BUILDDIR"
mkdir -p "$BUILDDIR"
pushd "$BUILDDIR"
do_configure_outside --enable-optimized --disable-assertions --disable-libedit
do_make clang-only
do_make install-clang
popd
